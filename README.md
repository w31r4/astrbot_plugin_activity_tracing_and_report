# AstrBot Activity Tracing & Report

**用途**：让管理员指定某位群友，立刻回溯其最近 2000 条上下文，并持续监听生成内存片段，随后通过 RAG + 多智能体提示词把“今天会不会来吃饭”“是不是还在打某款游戏”之类的问题交给 AstrBot 当前配置的 LLM Provider 来评估。

## 能力
- **精确监听**：管理员输入目标 ID（或 @）后，插件会尽力从 `PlatformMessageHistory` 中回溯 2000 条消息（仅限开启平台级存档的适配器，如 WebChat），并在内存里构建该会话的时间序列。
- **实时采集**：后续所有自然消息都会写入会话滑动窗口（默认 6000 条），被监听的成员会额外拥有 2000 条个人索引，可随时用于 RAG。
- **回到过去**：`rewind` 能直查“某人某天是否提过某句话/做过某事”，优先命中历史索引数据库；若没有索引，则回退到插件内存。
- **展望未来**：`forecast add` 可为任意 target 配置关键词+阈值（默认 85%），在近窗口内匹配度超标即自动向管理员群发预警。
- **时间敏感检索**：`ask` 指令会解析 “今天/昨天/今晚” 等时间词，把问题拆成关键词 + 时间窗口，选出最相关的语境，并附带周围数条上下文。
- **多智能体分析**：插件在调用 `event.request_llm` 时，给模型提供“观察员/时间线/推理官”三段式 system prompt，要求 LLM 汇报事实、校准时间、给出概率判断与下一步建议。

## 索引依赖
- 建议配合 `astrbot_plugin_history_indexer`（历史消息索引器）或自研模块，将 QQ / 群聊 / 好友的原始消息落到独立数据库中（SQLite/PostgreSQL 均可），并暴露读取接口。
- 本插件在执行 `/activity watch` 时会优先从该索引数据库读取数据，其次才尝试 `PlatformMessageHistory`；若两者皆不可用，回溯功能将退化为“仅记录 watch 之后的新消息”。
- 部署顺序：**先启用索引插件，确认其在写库，再加载本插件**。否则无法达到“向上 2000 条”与“回到过去”业务设想。

## 指令

| 指令 | 权限 | 说明 |
| --- | --- | --- |
| `/activity watch <id>` 或 `/activity watch @某人` | 管理员 | 将成员加入监听列表；若平台开启了 `PlatformMessageHistory`，会自动向上回溯 2000 条，用作初始知识库。 |
| `/activity drop <id>` | 管理员 | 停止监听目标，清空其个人索引。 |
| `/activity list` | 所有人 | 查看当前会话的监听对象、已收集条数、最近更新等状态。 |
| `/activity snapshot <id> [window小时]` | 所有人 | 对目标在最近 N 小时内的发言做本地统计（情绪 / 提问密度 / 动作关键词等）。 |
| `/activity rewind <id> <YYYY-MM-DD> <关键词>` | 所有人 | “回到过去”：判断目标在指定日期是否提及某句话/事件。 |
| `/activity ask <id> <问题>` | 所有人 | 构建 RAG 片段并向 LLM 提问，例如 ` /activity ask id:123 今天会来晚饭吗? `。支持 `今天/昨天/今晚/上周` 等时间词。 |
| `/activity forecast add <id> <label> [threshold] <关键词>` | 管理员 | “展望未来”：追加预测规则，匹配度 ≥ 阈值（默认 0.85）则给管理员发预警。 |
| `/activity forecast rm <label>` | 管理员 | 删除指定预测规则。 |
| `/activity forecast ls` | 所有人 | 查看当前会话已配置的预测规则。 |

> - `id:` 前缀可直接指定平台统一 ID；无法 @ 时可用 `id:123456789`。
> - 所有监听配置与缓存都只存在于内存，AstrBot 重启后需要重新 watch。

## 工作流程
1. 管理员执行 `/activity watch ...`，插件尝试读取历史记录，并初始化个人索引。
2. 插件持续监听该会话内的所有自然消息（忽略机器人自身），将其写入会话滑动窗口，并同步更新被监听成员的专属记录。
3. 用户发送 `/activity ask ...` 后，插件：
   - 分析问题中的时间词，确定重点区间；
   - 在个人索引 + 会话上下文中检索最相关的若干片段，并进行简单压缩；
   - 把整理好的片段、覆盖范围、时间提示与问题本体一起提交给 AstrBot 已启用的 LLM Provider；
   - 返回由多智能体提示词约束后的回复（观察员 / 时间线 / 推理官）。
4. 如配置了 `forecast`，一旦目标的实时消息在短时间内高度命中关键词（≥ 阈值），插件会自动向管理员所在会话发送“展望未来”预警，管理员可立即 `/activity rewind` + `/activity ask` 做交叉验证。

## 数据与隐私
- 不落盘、不上传，仅存活于 AstrBot 进程内存。
- 回溯功能依赖 `PlatformMessageHistoryManager`，只有为该平台开启了“平台消息存档”后才可能拿到历史；否则仅能从 watch 指令之后开始累计数据。
- 可随时通过 `/activity drop` 立即删除监控条目。

## 安装
把 `astrbot_plugin_activity_tracing_and_report` 放进 `data/plugins`，在 AstrBot WebUI 中启用即可。无需额外依赖，但为了获得“向上 2000 条”能力，建议同时在目标平台开启消息存档。
